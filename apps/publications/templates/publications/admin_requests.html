{% extends "core/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin_publications.css' %}">

{% endblock %}

{% block title %}Publication Requests · Admin{% endblock %}

{% block content %}
<div class="card">
  <h1 class="page-title">Publication Requests</h1>
  <p class="muted">Review and manage all publication requests.</p>

  <div class="tabs">
    <a class="tab {% if not status_filter or status_filter == 'all' %}active{% endif %}" href="{% url 'publications:admin_requests' %}?status=all">
      All <span class="pill">{{ status_counts.total }}</span>
    </a>

    <a class="tab {% if status_filter == 'pending_admin' %}active{% endif %}" href="{% url 'publications:admin_requests' %}?status=pending_admin">
      Pending Admin <span class="pill">{{ status_counts.pending_admin }}</span>
    </a>

    <a class="tab {% if status_filter == 'pending_cheffe' %}active{% endif %}" href="{% url 'publications:admin_requests' %}?status=pending_cheffe">
      Pending Cheffe <span class="pill">{{ status_counts.pending_cheffe }}</span>
    </a>

    <a class="tab {% if status_filter == 'approved' %}active{% endif %}" href="{% url 'publications:admin_requests' %}?status=approved">
      Approved <span class="pill">{{ status_counts.approved }}</span>
    </a>

    <a class="tab {% if status_filter == 'rejected_by_cheffe' %}active{% endif %}" href="{% url 'publications:admin_requests' %}?status=rejected_by_cheffe">
      Rejected by Cheffe <span class="pill">{{ status_counts.rejected_cheffe }}</span>
    </a>

    <a class="tab {% if status_filter == 'rejected_by_admin' %}active{% endif %}" href="{% url 'publications:admin_requests' %}?status=rejected_by_admin">
      Rejected by Admin <span class="pill">{{ status_counts.rejected_admin }}</span>
    </a>
  </div>

  {% if publications %}
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Target</th>
            <th>Requested by</th>
            <th>Team</th>
            <th>Status</th>
            <th>Created</th>
            <th>Review</th>
          </tr>
        </thead>
        <tbody>
        {% for pub in publications %}
          <tr>
            <td class="mono">#{{ pub.id }}</td>

            <td>
              <div class="mono">{{ pub.target_content_type.app_label }}/{{ pub.target_content_type.model }}</div>
              <div class="small">object_id={{ pub.target_object_id }}</div>
            </td>

            <td class="mono">{{ pub.requested_by.email }}</td>

            <td>
              {% if pub.team %}
                {{ pub.team.name }}
              {% else %}
                <span class="muted">—</span>
              {% endif %}
            </td>

            <td>
              {% if pub.status == pub.Status.APPROVED %}
                <span class="badge badge-approved">APPROVED</span>
              {% elif pub.status == pub.Status.PENDING_ADMIN or pub.status == pub.Status.PENDING_CHEFFE %}
                <span class="badge badge-pending">{{ pub.status }}</span>
              {% else %}
                <span class="badge badge-rejected">{{ pub.status }}</span>
              {% endif %}
            </td>

            <td class="mono">{{ pub.created_at|date:"Y-m-d H:i" }}</td>

            <td>
              {% if pub.status == pub.Status.PENDING_ADMIN %}
                <form method="post" action="{% url 'publications:admin_review' pub.id %}">
                  {% csrf_token %}
                  <div class="actions">
                    <button class="btn" type="submit" name="action" value="approve">Approve</button>
                    <input class="comment" type="text" name="comment" placeholder="Reason required for reject">
                    <button class="btn btn-danger" type="submit" name="action" value="reject">Reject</button>
                  </div>
                </form>
              {% else %}
                <span class="muted">—</span>
              {% endif %}
            </td>
          </tr>

          {% if pub.status == pub.Status.REJECTED_BY_CHEFFE and pub.cheffe_review_comment %}
            <tr>
              <td colspan="7" class="small">
                <strong>Cheffe comment:</strong> {{ pub.cheffe_review_comment }}
              </td>
            </tr>
          {% endif %}

          {% if pub.status == pub.Status.REJECTED_BY_ADMIN and pub.admin_review_comment %}
            <tr>
              <td colspan="7" class="small">
                <strong>Admin comment:</strong> {{ pub.admin_review_comment }}
              </td>
            </tr>
          {% endif %}

        {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted">No publication requests found.</p>
  {% endif %}
</div>
{% endblock %}
