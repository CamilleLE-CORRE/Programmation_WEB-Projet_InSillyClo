{% extends "core/base.html" %}

{% block title %}Campaign Templates ¬∑ InSillyClo{% endblock %}

{% block content %}
<h1>Campaign Templates</h1>

<h2>Public templates</h2>
{% if public_templates %}
  <ul>
    {% for t in public_templates %}
      <li>
        {{ t.name }} ‚Äî
        <a href="{% url 'campaigns:download_public_template' t.id %}?format=csv">csv</a> |
        <a href="{% url 'campaigns:download_public_template' t.id %}?format=xlsx">xlsx</a>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p>No public templates available.</p>
{% endif %}


<h2>Your templates</h2>

{% if user_templates %}
  <ul>
    {% for t in user_templates %}
      <li>
        {{ t.name }} ‚Äî
        <a href="{% url 'campaigns:download_template' t.id %}?format=csv">csv</a> |
        <a href="{% url 'campaigns:download_template' t.id %}?format=xlsx">xlsx</a>

        <a href="#" class="info-icon"
           data-template-name="{{ t.name }}"
           data-template-type="{{ t.template_type }}"
           data-enzyme="{{ t.restriction_enzyme }}"
           data-separator="{{ t.separator }}"
           data-created="{{ t.created_at|date:'d/m/Y - H:i' }}"
           data-owner="{% if t.owner.first_name %}{{ t.owner.first_name }} {{ t.owner.last_name }}{% else %}{{ t.owner.username }}{% endif %}"
           data-is-public="{{ t.is_public|yesno:'Yes,No' }}"
           onclick="showTemplateInfo(event, this)">‚ÑπÔ∏è</a>

        <a href="#" class="delete-icon"
           onclick='confirmDelete(event, "{{ t.id }}", "{{ t.name|escapejs }}")'>üóëÔ∏è</a>
      </li>
    {% endfor %}
  </ul>

{% else %}
  <p>No templates yet.</p>
{% endif %}

<p><a href="{% url 'campaigns:create_template' %}">Create a new template</a></p>

<div id="info-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Template Information</h2>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>
    <div id="modal-body"></div>
  </div>
</div>

<form id="delete-form" method="post" style="display:none;">
  {% csrf_token %}
</form>

<script>
  function confirmDelete(event, templateId, templateName) {
    event.preventDefault();
    const ok = confirm(`Supprimer "${templateName}" ?`);
    if (!ok) return;
    const form = document.getElementById('delete-form');
    form.action = "{% url 'campaigns:delete_template' 0 %}".replace('0', templateId);
    form.submit();
  }

  function showTemplateInfo(event, element) {
    event.preventDefault();
    const templateName = element.getAttribute('data-template-name');
    const templateType = element.getAttribute('data-template-type');
    const enzyme = element.getAttribute('data-enzyme');
    const separator = element.getAttribute('data-separator');
    const created = element.getAttribute('data-created');
    const owner = element.getAttribute('data-owner');
    const isPublic = element.getAttribute('data-is-public');

    document.getElementById('modal-body').innerHTML = `
      <p><strong>Name:</strong> ${templateName}</p>
      <p><strong>Type:</strong> ${templateType}</p>
      <p><strong>Enzyme:</strong> ${enzyme}</p>
      <p><strong>Separator:</strong> ${separator}</p>
      <p><strong>Created:</strong> ${created}</p>
      <p><strong>Owner:</strong> ${owner}</p>
      <p><strong>Public:</strong> ${isPublic}</p>
    `;
    document.getElementById('info-modal').style.display = 'block';
  }

  function closeModal() {
    document.getElementById('info-modal').style.display = 'none';
  }

  window.onclick = function(event) {
    const modal = document.getElementById('info-modal');
    if (event.target === modal) closeModal();
  }

  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') closeModal();
  });
</script>
{% endblock %}
