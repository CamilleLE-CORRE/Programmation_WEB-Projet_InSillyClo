{% extends "core/base.html" %}

{% block title %}Campaign Simulation · InSillyClo{% endblock %}

{% block content %}

<div class="container">

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h1>Campaign Simulation</h1>
        
        {% if user.is_authenticated %}
        <a href="{% url 'simulations:history' %}" class="btn btn-secondary">
            <i class="bi bi-clock-history"></i> History
        </a>
        {% endif %}
    </div>

    {% if messages %}
    <ul class="messages">
        {% for message in messages %}
        <li class="{{ message.tags }}">
            {{ message }}
        </li>
        {% endfor %}
    </ul>
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="simulationForm" novalidate>
        {% csrf_token %}
        
        {% if prefill.old_sim_id %}
            <input type="hidden" name="old_sim_id" value="{{ prefill.old_sim_id }}">
        {% endif %}

        <input type="hidden" name="clear_primers" id="clear_primers" value="false">
        <input type="hidden" name="clear_concentrations" id="clear_concentrations" value="false">

        <div class="card" style="margin-bottom: 24px;">
            <h2>Identification</h2>
            <label for="simulation_name">Campaign Name (Optional)</label>
            <input type="text" 
                   id="simulation_name" 
                   name="simulation_name" 
                   value="{{ prefill.name|default:'' }}"
                   placeholder="Ex: Golden Gate Assembly - Batch 1">
            <p style="font-size: 0.9em; color: var(--muted); margin-top: 6px;">
                Give a name to easily find this simulation in your history.
            </p>
        </div>

        <div class="card" style="margin-bottom: 24px;">
            <h2>Required files</h2>
            
            <div class="row">
                <div class="col-md-12" style="margin-bottom: 24px;"> 
                    <label for="template_file">Campaign Template (Excel/CSV)</label>
                    
                    {% if prefill.prev_template %}
                        <div class="messages" style="margin-bottom: 5px;">
                            <li class="success" style="padding: 5px 10px; font-size: 0.9em;">
                                Previous file detected: <strong>{{ prefill.prev_template }}</strong>
                            </li>
                        </div>
                    {% endif %}
                    
                    <input type="file" id="template_file" name="template_file" accept=".xlsx,.csv" 
                           {% if not prefill.prev_template %}required{% endif %}>
                    <p style="font-size: 0.85em; color: var(--muted); margin-top: 4px;">
                        File describing the assemblies to be made.
                    </p>
                </div>

                <div class="col-md-6" style="margin-bottom: 24px;">
                    <label for="sequences_archive">Sequence Archive (ZIP)</label>

                    {% if prefill.prev_zip %}
                        <div class="messages" style="margin-bottom: 5px;">
                            <li class="success" style="padding: 5px 10px; font-size: 0.9em;">
                                Previous archive: <strong>{{ prefill.prev_zip }}</strong>
                            </li>
                        </div>
                    {% endif %}
                    
                    <input type="file" id="sequences_archive" name="sequences_archive" accept=".zip"
                           {% if not prefill.prev_zip and not prefill.use_collections %}required{% endif %}
                           {% if prefill.prev_zip %}data-prev-exists="true"{% endif %}>
                    <p style="font-size: 0.85em; color: var(--muted); margin-top: 4px;">
                        A .zip archive containing all .gb files.
                    </p>

                    {% if user.is_authenticated %}
                    <div style="margin-top: 12px; padding: 12px; border: 1px solid var(--border); border-radius: 12px; background: var(--bg);">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="use_collections" name="use_collections" 
                                   style="width: auto;"
                                   {% if prefill.use_collections %}checked{% endif %}>
                            <label for="use_collections" style="margin:0; cursor:pointer;">Use my collections</label>
                        </div>

                        <div id="collections_selector" style="margin-top: 10px;" {% if not prefill.use_collections %}hidden{% endif %}>
                            {% if user_collections %}
                                <div style="max-height: 150px; overflow-y: auto;">
                                    {% for collection in user_collections %}
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                        <input type="checkbox" name="selected_collections" value="{{ collection.id }}" id="c{{ collection.id }}" style="width: auto;"
                                        {% if collection.id in prefill.selected_collection_ids %}checked{% endif %}>
                                        <label for="c{{ collection.id }}" style="margin:0; font-weight: normal;">{{ collection.name }}</label>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p style="color: var(--danger); font-size: 0.9em;">No collection found.</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-6" style="margin-bottom: 24px;">
                    <label for="correspondence_file">Correspondence Table (CSV) <span style="color: var(--danger);">*</span></label>
                    
                    {% if prefill.prev_correspondence %}
                        <div class="messages" style="margin-bottom: 5px;">
                            <li class="success" style="padding: 5px 10px; font-size: 0.9em;">
                                Previous table: <strong>{{ prefill.prev_correspondence }}</strong>
                            </li>
                        </div>
                    {% endif %}

                    <input type="file" id="correspondence_file" name="correspondence_file" accept=".csv"
                           {% if not prefill.prev_correspondence %}required{% endif %}>
                    <p style="font-size: 0.85em; color: var(--muted); margin-top: 4px;">
                        File for linking plasmid identifiers.
                    </p>
                </div>
            </div>
        </div>

        <div style="margin-bottom: 24px;">
            <button type="button" id="btn-options-toggle" class="btn btn-secondary" style="width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                <span><i class="bi bi-sliders"></i> Advanced Parameters</span>
                <i class="bi bi-chevron-down" id="chevron-icon"></i>
            </button>
            
            <div id="options-content" class="card" 
                 {% if not prefill.pcr_primers and not prefill.digestion_enzymes and not prefill.prev_primers and not prefill.prev_concentrations %}hidden{% endif %} 
                 style="border-top-left-radius: 0; border-top-right-radius: 0; margin-top: -10px; padding-top: 20px;">
                <div class="row">
                    <div class="col-md-6" style="margin-bottom: 16px;">
                        <label>Primer Pairs (IDs)</label>
                        <textarea name="pcr_primers" rows="2" placeholder="Ex: P29, P30">{{ prefill.pcr_primers|default:'' }}</textarea>
                        
                        <label style="margin-top: 10px; font-weight: normal; font-size: 0.9em;">Primers Database (CSV)</label>
                        
                        {% if prefill.prev_primers %}
                            <div class="messages" id="msg-prev-primers" style="margin-bottom: 5px;">
                                <li class="success" style="padding: 5px 10px; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                    <span>Detected: <strong>{{ prefill.prev_primers }}</strong></span>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearOptionalFile('primers')" style="padding: 0px 6px; font-size: 0.8em; margin-left: 10px;">
                                        <i class="bi bi-x-lg"></i> Remove
                                    </button>
                                </li>
                            </div>
                        {% endif %}
                        
                        <input type="file" name="primers_file" accept=".csv">
                    </div>

                    <div class="col-md-6" style="margin-bottom: 16px;">
                        <label for="digestion_enzymes">Digestion Enzymes</label>
                        <input type="text" id="digestion_enzymes" name="digestion_enzymes" value="{{ prefill.digestion_enzymes|default:'' }}" placeholder="Ex: BsmBI, NotI">
                        
                        <label style="margin-top: 10px; font-weight: normal; font-size: 0.9em;">Specific Concentrations (CSV)</label>
                        
                        {% if prefill.prev_concentrations %}
                            <div class="messages" id="msg-prev-concentrations" style="margin-bottom: 5px;">
                                <li class="success" style="padding: 5px 10px; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                    <span>Detected: <strong>{{ prefill.prev_concentrations }}</strong></span>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearOptionalFile('concentrations')" style="padding: 0px 6px; font-size: 0.8em; margin-left: 10px;">
                                        <i class="bi bi-x-lg"></i> Remove
                                    </button>
                                </li>
                            </div>
                        {% endif %}

                        <input type="file" name="concentrations_file" accept=".csv">
                    </div>
                    
                    <div class="col-md-6">
                        <label>Default Concentration (ng/µL)</label>
                        <input type="number" name="default_concentration" placeholder="200" value="{{ prefill.default_concentration|default:'200' }}">
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-top: 32px;">
            <button type="submit" class="btn" style="width: 100%; padding: 16px; font-size: 1.1em;">
                START SIMULATION
            </button>
        </div>

    </form>
</div>

<script>
// Fonction pour supprimer un fichier optionnel pré-rempli
function clearOptionalFile(type) {
    if (type === 'primers') {
        document.getElementById('msg-prev-primers').style.display = 'none';
        document.getElementById('clear_primers').value = 'true';
    } else if (type === 'concentrations') {
        document.getElementById('msg-prev-concentrations').style.display = 'none';
        document.getElementById('clear_concentrations').value = 'true';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const useCollections = document.getElementById('use_collections');
    const collectionsSelector = document.getElementById('collections_selector');
    const seqArchive = document.getElementById('sequences_archive');

    function updateCollectionsState() {
        if (!useCollections) return;
        if (useCollections.checked) {
            if(collectionsSelector) {
                collectionsSelector.hidden = false;
                collectionsSelector.style.display = 'block'; 
            }
            if(seqArchive) {
                seqArchive.removeAttribute('required');
                seqArchive.disabled = true;
            }
        } else {
            if(collectionsSelector) {
                collectionsSelector.hidden = true;
                collectionsSelector.style.display = 'none';
            }
            if(seqArchive) {
                if (!seqArchive.getAttribute('data-prev-exists')) {
                    seqArchive.setAttribute('required', 'required');
                }
                seqArchive.disabled = false;
            }
        }
    }

    if (useCollections) {
        useCollections.addEventListener('change', updateCollectionsState);
        if(useCollections.checked) updateCollectionsState();
    }

    const btnToggle = document.getElementById('btn-options-toggle');
    const contentDiv = document.getElementById('options-content');
    const chevron = document.getElementById('chevron-icon');

    if (btnToggle && contentDiv) {
        if (!contentDiv.hidden && chevron) {
             chevron.className = 'bi bi-chevron-up';
        }

        btnToggle.addEventListener('click', function() {
            const isHidden = contentDiv.style.display === 'none' || contentDiv.hidden;

            if (isHidden) {
                contentDiv.hidden = false;
                contentDiv.style.display = 'block';
                if(chevron) chevron.className = 'bi bi-chevron-up';
            } else {
                contentDiv.style.display = 'none';
                contentDiv.hidden = true;
                if(chevron) chevron.className = 'bi bi-chevron-down';
            }
        });
    }
});
</script>
{% endblock %}