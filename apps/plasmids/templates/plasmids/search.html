{% extends "core/base.html" %}
{% block title %}Plasmid Browser{% endblock %}

{% block content %}

<h1>Plasmid Browser</h1>

<form method="get">

    <div class="card">
        {{ form.sequence_pattern.label_tag }}
        {{ form.sequence_pattern }}
    </div>

    <div class="card">
        {{ form.name.label_tag }}
        {{ form.name }}
    </div>

    <!-- Contraintes sur annotations -->
    <div class="card">
        <h3>Annotations</h3>
        <div id="annotation-constraints"></div>
        <button type="button" class="btn btn-secondary" id="add-annotation">
            + Add annotation constraint
        </button>
    </div>

    <!-- Contraintes sur sites de restriction -->
    <div class="card">
        <h3>Restriction Enzyme Sites</h3>
        <div id="restriction-constraints"></div>
        <button type="button" class="btn btn-secondary" id="add-restriction">
            + Add restriction constraint
        </button>
    </div>

    <button type="submit" class="btn">Search</button>
</form>

<hr>

{% if plasmids != None %}
<h2>Search Results</h2>

{% if plasmids %}
<p>{{ plasmids|length }} plasmids found.</p>

<table class="plasmid-table">
    <thead>
        <tr>
            <th>Name</th>
            <th>Length</th>
            <th>Collection</th>
        </tr>
    </thead>
    <tbody>
        {% for plasmid in plasmids %}
        <tr class="clickable-row"
            data-href="{% url 'plasmids:plasmid_detail' plasmid.id %}">
            <td>{{ plasmid.name }}</td>
            <td>{{ plasmid.length }} bp</td>
            <td>{{ plasmid.collection.name }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% else %}
<p class="text-muted">No plasmids found.</p>
{% endif %}
{% endif %}

{{ annotation_constraints|json_script:"annotation-constraints-data" }}
{{ restriction_constraints|json_script:"restriction-constraints-data" }}

<script>
document.addEventListener("DOMContentLoaded", () => {

    function addRow(container, name, mode, inputName, selectName) {
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.gap = "8px";
        row.style.marginBottom = "6px";

        row.innerHTML = `
            <input type="text" name="${inputName}" value="${name || ""}">
            <select name="${selectName}">
                <option value="present" ${mode === "present" ? "selected" : ""}>Must be present</option>
                <option value="absent" ${mode === "absent" ? "selected" : ""}>Must be absent</option>
            </select>
            <button type="button" class="btn btn-danger">âœ–</button>
        `;

        row.querySelector("button").onclick = () => row.remove();
        container.appendChild(row);
    }

    const annotationContainer = document.getElementById("annotation-constraints");
    const restrictionContainer = document.getElementById("restriction-constraints");

    const annotationConstraints = JSON.parse(
        document.getElementById("annotation-constraints-data").textContent
    );

    const restrictionConstraints = JSON.parse(
        document.getElementById("restriction-constraints-data").textContent
    );

    annotationConstraints.forEach(c =>
        addRow(annotationContainer, c.name, c.mode, "annotation_name", "annotation_mode")
    );

    restrictionConstraints.forEach(c =>
        addRow(restrictionContainer, c.name, c.mode, "restriction_name", "restriction_mode")
    );

    document.getElementById("add-annotation").onclick = () =>
        addRow(annotationContainer, "", "present", "annotation_name", "annotation_mode");

    document.getElementById("add-restriction").onclick = () =>
        addRow(restrictionContainer, "", "present", "restriction_name", "restriction_mode");

    document.querySelectorAll(".clickable-row").forEach(row => {
        row.onclick = () => window.location = row.dataset.href;
    });
});
</script>


{% endblock %}