{% extends "core/base.html" %}
{% block title %}Plasmid Browser{% endblock %}

{% block content %}

<div style="display:flex; justify-content:space-between; align-items:center;">
    <h1>Plasmid Browser</h1>

    <a class="btn" href="{% url 'plasmids:plasmid_list' %}">
        Back to Plasmid List
    </a>
</div>

<br>

<form method="get" action="{% url 'plasmids:search' %}">
    {% csrf_token %}

    <div class="card" style="margin-bottom:16px;">
        {{ form.sequence_pattern.label_tag }}
        {{ form.sequence_pattern }}
    </div>

    <div class="card" style="margin-bottom:16px;">
        {{ form.name.label_tag }}
        {{ form.name }}
    </div>

    <!-- Tableau tri-state Types -->
    <div class="card" style="margin-bottom:16px;">
        <h3>Types de plasmide</h3>
        <table class="tri-state-table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Presence</th>
                </tr>
            </thead>
            <tbody>
                {% for t, t_label in PLASMID_TYPE_CHOICES %}
                <tr>
                    <td>{{ t_label }}</td>
                    <td>
                        <div class="tri-state-cell" data-name="{{ t }}" data-value="indifferent"></div>
                        <input type="hidden" name="type_{{ t }}" value="indifferent">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Tableau tri-state Sites ER -->
    <div class="card" style="margin-bottom:16px;">
        <h3>Sites de restriction</h3>
        <table class="tri-state-table">
            <thead>
                <tr>
                    <th>Restriction Enzyme Site</th>
                    <th>Presence</th>
                </tr>
            </thead>
            <tbody>
                {% for s, s_label in RESTRICTION_SITE_CHOICES %}
                <tr>
                    <td>{{ s_label }}</td>
                    <td>
                        <div class="tri-state-cell" data-name="{{ s }}" data-value="indifferent"></div>
                        <input type="hidden" name="site_{{ s }}" value="indifferent">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <button type="submit" class="btn">Search</button>
</form>

<hr>

{% if plasmids != None %}

<h1>Search Results</h1>

{% if plasmids %}
    <p class="text-center">
        {{ plasmids|length }} plasmids found.
    </p>

    <!-- ðŸ”´ Card autour du tableau -->
    <div class="card">
        <table class="plasmid-table rounded-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Length</th>
                    <th>Collection</th>
                </tr>
            </thead>
            <tbody>
                {% for plasmid in plasmids %}
                <tr class="clickable-row"
                    data-href="{% url 'plasmids:plasmid_detail' plasmid.identifier %}">
                    <td>{{ plasmid.name }}</td>
                    <td>{{ plasmid.length }} bp</td>
                    <td>
                        {{ plasmid.collection.name }}
                        {% if plasmid.collection.is_public %}
                            <span class="badge bg-success">Public</span>
                        {% else %}
                            <span class="badge bg-secondary">Private</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

{% else %}
    <p class="text-center text-muted">
        No plasmids matching your search were found.
    </p>

    <br>
    <a class="btn" href="{% url 'plasmids:plasmid_list' %}">
        Back to plasmid list
    </a>
{% endif %}
{% endif %}

<!-- JS tri-state -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const cells = document.querySelectorAll(".tri-state-cell");
    cells.forEach(cell => {
        cell.addEventListener("click", () => {
            const hiddenInput = cell.nextElementSibling;
            let current = cell.dataset.value;

            if (current === "indifferent") {
                cell.dataset.value = "yes";
                hiddenInput.value = "yes";
                cell.classList.remove("absent");
                cell.classList.add("present");
                cell.innerHTML = "âœ”";
            } else if (current === "yes") {
                cell.dataset.value = "no";
                hiddenInput.value = "no";
                cell.classList.remove("present");
                cell.classList.add("absent");
                cell.innerHTML = "âœ–";
            } else {
                cell.dataset.value = "indifferent";
                hiddenInput.value = "indifferent";
                cell.classList.remove("absent");
                cell.innerHTML = "";
            }
        });
    });

    const rows = document.querySelectorAll(".clickable-row");
    rows.forEach(row => {
        row.addEventListener("click", () => {
            window.location = row.dataset.href;
        });
    });
});
</script>

{% endblock %}
