{% extends "core/base.html" %}
{% block title %}Plasmid Browser{% endblock %}

{% block content %}

<div style="display:flex; justify-content:space-between; align-items:center;">
    <h1>Plasmid Browser</h1>

    <a class="btn" href="{% url 'plasmids:plasmid_list' %}">
        Back to Plasmid List
    </a>
</div>

<br>

<form method="get" action="{% url 'plasmids:search' %}">
    {% csrf_token %}

    <div class="card" style="margin-bottom:16px;">
        {{ form.sequence_pattern.label_tag }}
        {{ form.sequence_pattern }}
    </div>

    <div class="card" style="margin-bottom:16px;">
        {{ form.name.label_tag }}
        {{ form.name }}
    </div>

    <!-- Tableau tri-state Types -->
    <div class="card" style="margin-bottom:16px;">
        <h3>Types de plasmide</h3>
        <table class="tri-state-table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Presence</th>
                </tr>
            </thead>
            <tbody>
                {% for t, t_label in PLASMID_TYPE_CHOICES %}
                <tr>
                    <td>{{ t_label }}</td>
                    <td>
                        <div class="tri-state-cell" data-name="{{ t }}" data-value="indifferent"></div>
                        <input type="hidden" name="type_{{ t }}" value="indifferent">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Tableau tri-state Sites ER -->
    <div class="card" style="margin-bottom:16px;">
        <h3>Sites de restriction</h3>
        <table class="tri-state-table">
            <thead>
                <tr>
                    <th>Restriction Enzyme Site</th>
                    <th>Presence</th>
                </tr>
            </thead>
            <tbody>
                {% for s, s_label in RESTRICTION_SITE_CHOICES %}
                <tr>
                    <td>{{ s_label }}</td>
                    <td>
                        <div class="tri-state-cell" data-name="{{ s }}" data-value="indifferent"></div>
                        <input type="hidden" name="site_{{ s }}" value="indifferent">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <button type="submit" class="btn">Search</button>
</form>

<!-- JS tri-state -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const cells = document.querySelectorAll(".tri-state-cell");
    cells.forEach(cell => {
        cell.addEventListener("click", () => {
            const hiddenInput = cell.nextElementSibling;
            let current = cell.dataset.value;

            if (current === "indifferent") {
                cell.dataset.value = "yes";
                hiddenInput.value = "yes";
                cell.classList.remove("absent");
                cell.classList.add("present");
                cell.innerHTML = "✔";
            } else if (current === "yes") {
                cell.dataset.value = "no";
                hiddenInput.value = "no";
                cell.classList.remove("present");
                cell.classList.add("absent");
                cell.innerHTML = "✖";
            } else {
                cell.dataset.value = "indifferent";
                hiddenInput.value = "indifferent";
                cell.classList.remove("absent");
                cell.innerHTML = "";
            }
        });
    });
});
</script>

<hr>

{% if plasmids != None %}

<h1>Search Results</h1>

{% if plasmids %}
    <p class="text-center">
        {{ plasmids|length }} plasmids found.
    </p>

    <table class="table plasmid-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Length</th>
                <th>Collection</th>
            </tr>
        </thead>
        <tbody>
            {% for plasmid in plasmids %}
            <tr class="clickable-row"
                data-href="{% url 'plasmids:plasmid_detail' plasmid.identifier %}">
                <td>{{ plasmid.name }}</td>
                <td>{{ plasmid.length }} bp</td>
                <td>
                    {{ plasmid.collection.name }}
                    {% if plasmid.collection.is_public %}
                        <span class="badge bg-success">Public</span>
                    {% else %}
                        <span class="badge bg-secondary">Private</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

{% else %}
    <p class="text-center text-muted">
        No plasmids matching your search were found.
    </p>

    <br>
    <a class="btn" href="{% url 'plasmids:plasmid_list' %}">
        Back to plasmid list
    </a>
{% endif %}
{% endif %}

<style>
/* ===== TRI-STATE ===== */
.tri-state-cell {
    width: 30px;
    height: 30px;
    border: 1px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: white;
    font-size: 18px;
    transition: all 0.2s;
}
.tri-state-cell.present {
    background-color: #d1fae5;
    color: #065f46;
}
.tri-state-cell.absent {
    background-color: #fee2e2;
    color: #991b1b;
}
.tri-state-table {
    border-collapse: separate;
    border-spacing: 20px 5px;
}
.tri-state-table th,
.tri-state-table td {
    text-align: center;
    vertical-align: middle;
}

/* ===== TABLEAU RESULTATS (IDENTIQUE search_results.html) ===== */
.plasmid-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 15px;
}
.plasmid-table thead tr {
    background-color: var(--primary);
    color: #fff;
    text-align: left;
}
.plasmid-table th,
.plasmid-table td {
    padding: 14px 12px;
    border-bottom: 1px solid var(--border);
}
.plasmid-table tbody tr:nth-child(odd) {
    background-color: var(--card);
}
.plasmid-table tbody tr:nth-child(even) {
    background-color: var(--primary-soft);
}
.clickable-row {
    cursor: pointer;
    transition: background-color 0.2s;
}
.clickable-row:hover td {
    background-color: var(--primary);
    color: #fff;
}
.clickable-row .badge {
    transition: background-color 0.2s;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const rows = document.querySelectorAll(".clickable-row");
    rows.forEach(row => {
        row.addEventListener("click", () => {
            window.location = row.dataset.href;
        });
    });
});
</script>

{% endblock %}
